.DELETE_ON_ERROR:

srcdir := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
builddir := $(srcdir)/build

BENCHMARKS_DIR := $(srcdir)/benchmarks/
SUBDIRS := $(BENCHMARKS_DIR)01-sieve/ $(BENCHMARKS_DIR)02-formatted-read/

BUILDDIR_COMP := build/
BUILD_DIRS := $(BENCHMARKS_DIR)01-sieve/build $(BENCHMARKS_DIR)02-formatted-read/$(BUILDDIR_COMP)


export COMPILERS := clang++ g++

LN_S := ln -s
MKDIR_P := mkdir -p
CP := cp


.PHONY: all
all: copy-plots


.PHONY: run-benchmarks
run-benchmarks:
	@for dir in $(BUILD_DIRS); do $(MAKE) -C $${dir} COMPILERS="$(COMPILERS)"; done



.PHONY: copy-plots
copy-plots: run-benchmarks | $(srcdir)/plots
	@for dir in $(SUBDIRS); \
		do $(CP) $${dir}/$(BUILDDIR_COMP)benchmark.png $(srcdir)/plots/benchmark-`basename $${dir}`.png; \
	done


#README.org: $(srcdir)/README.org.in


$(srcdir)/plots:
	$(MKDIR_P) $@

$(builddir)/.config: | $(builddir)
	@for dir in $(SUBDIRS); do cd $${dir} && ./configure && cd $${OLDPWD}; done
	@$(LN_S) $(srcdir)/Makefile.in $(builddir)/Makefile
	$(info Created $(builddir) and config file $(builddir)/.config)

config: $(builddir)/.config


$(builddir):
	@$(MKDIR_P) $@


.PHONY: clean

clean:
	rm -rf $(BUILD_DIRS)
