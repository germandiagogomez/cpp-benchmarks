.DELETE_ON_ERROR:

srcdir := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
builddir := $(srcdir)/build

BENCHMARKS_DIR := $(srcdir)/benchmarks/
SUBDIRS := $(BENCHMARKS_DIR)01-sieve/ $(BENCHMARKS_DIR)02-formatted-read/
BUILD_DIRS := $(BENCHMARKS_DIR)01-sieve/build $(BENCHMARKS_DIR)02-formatted-read/build

export COMPILERS := clang++ g++

LN_S := ln -s
MKDIR_P := mkdir -p
CP := cp

.PHONY: all
all: | $(srcdir)/plots
	@for dir in $(BUILD_DIRS); do $(MAKE) -C $${dir} COMPILERS="$(COMPILERS)"; done;
	i=1; \
	for dir in $(BUILD_DIRS); do $(CP) $${dir}/benchmark.png $(srcdir)/plots/benchmark-$${i}.png; i=$$(($$i+1)); done


$(srcdir)/plots:
	$(MKDIR_P) $@




$(builddir)/.config: | $(builddir)
	@for dir in $(SUBDIRS); do cd $${dir} && ./configure && cd $${OLDPWD}; done
	@$(LN_S) $(srcdir)/Makefile.in $(builddir)/Makefile
	$(info Created $(builddir) and config file $(builddir)/.config)

config: $(builddir)/.config


$(builddir):
	@$(MKDIR_P) $@


.PHONY: clean

clean:
	rm -rf $(BUILD_DIRS)
