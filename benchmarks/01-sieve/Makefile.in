.SUFFIXES:
.DELETE_ON_ERROR:

CXX := clang++
CPPFLAGS := -DNDEBUG
CXXFLAGS := -std=c++14 -O3

CPPFLAGS += -MMD -MP

srcdir := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
VPATH := $(srcdir)

plotdir := plot-output
objdir := .objs

MKDIR_P := mkdir -p
SOURCES := $(notdir $(wildcard $(srcdir)/*.cpp))
TARGETS := $(SOURCES:.cpp=)
OBJECTS := $(foreach s,$(SOURCES:.cpp=.o),$(objdir)/$(s))
BENCH_DATA := $(SOURCES:.cpp=.dat)

ranges_sieve_INCLUDES := -I$(srcdir)/../../submodules/range-v3/include


all: $(TARGETS)

$(TARGETS): % : $(objdir)/%.o
	$(CXX) $< -o $@

%.dat: %
	$(info Executing './$< 5' for generating benchmark file $@)
	$(file > $@,$(shell ./$< 5))

$(plotdir):
	mkdir $@

$(objdir)/%.o:%.cpp | $(objdir)
	$(CXX) $($(basename $(notdir $@))_INCLUDES) $(CPPFLAGS) $(CXXFLAGS) -c $< -o $@

$(objdir):
	$(MKDIR_P) $@

benchmark: $(BENCH_DATA)

.PHONY: all

-include $(foreach dep,$(SOURCES:.cpp=.d), $(objdir)/$(dep))

.PHONY: print-vars
print-vars:
	@$(foreach V,$(sort $(.VARIABLES)),$(if $(filter-out environment% default automatic,$(origin $V)),$(info $V=$(value $V))))
